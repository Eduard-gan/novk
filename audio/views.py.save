from django.shortcuts import render
from django.http import HttpResponse
from .models import Song 
from .forms import *
from django.core.files.storage import FileSystemStorage
from mutagen import id3
import random
from django.conf import settings
import os
from django.contrib.auth.decorators import login_required
import magic
from django.core.files import File

def _getRandomName_():
    return "".join([random.choice(list('123456789qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM')) for x in range(12)])

def _convertToUnicode_(PossibleCP1251String):
    convertedUnicodeString = ''
    for letter in PossibleCP1251String:
        temp = letter.encode('raw_unicode_escape')
        testnumber = int.from_bytes(temp,'big')
        if testnumber > 127 and testnumber < 256:
            convertedUnicodeString += ((temp.decode('cp1251')).encode('UTF-8')).decode()
        else:
            return(PossibleCP1251String)
    return(convertedUnicodeString)







@login_required
def music(request):
    songs = Song.objects.all().values()
    context = {}
    context.update({'songs':songs})
    return render(request,'music.html',context)

def upload(request):

    if request.method == 'GET':
        form = Upload()
        return render(request, 'upload.html', {'form': form})

    if request.method == 'POST':
        if request.FILES.get('file') != None:

            ### Сохранение файла во временной папке и отдача в сессию сведений о временном файле
            fs = FileSystemStorage( location=settings.MEDIA_ROOT + '/temp/' , 
                                    base_url=settings.MEDIA_URL + 'temp/')
            filename = fs.save(_getRandomName_(), request.FILES['file'])
            request.session['TempFileName'] = filename
            request.session['TempFileURL'] = fs.url(filename)
            request.session['TempFilePath'] = fs.path(filename)
            ###
            
            ### Анализ типа файла
            mime = magic.Magic(mime=True)
            FileType = mime.from_file(fs.path(filename))
            ###

            if FileType == 'audio/mpeg':
                ### Считывание и передача тэгов в форму для правки и подтверждения
                tags = id3.ID3(fs.path(filename))
                form = SongCommit( initial = {  'artist': _convertToUnicode_(tags['TPE1'][0]).title(),
                                                'title': _convertToUnicode_(tags['TIT2'][0]).title(),
                                                'album': _convertToUnicode_(tags['TALB'][0]).title(),
                                                'year': tags['TDRC'][0],
                                                'track': tags['TRCK'][0]}
                                  )
                ###
            else:
                form = SongCommit()
            return render(request, 'upload.html', {'form': form , 'uploaded_file_url': request.session.get('TempFileURL')} )
        elif request.FILES.get('file') == None:
            #Завершающий этап. Связываем принятые данные с новой формой
            form = SongCommit(request.POST)
            modelinstance = Song()
            #Временный файл перемещается в аудиохранилище.
            CommitedFilePath = settings.MEDIA_ROOT + '/audio/' + request.session.get('TempFileName') + '.mp3'
            os.rename( '{}'.format(request.session.get('TempFilePath')) , CommitedFilePath)

            #Создание файлового объекта Джанго из перемещенного файла для последующего крепления в форму.
#            with open(CommitedFilePath, 'w') as CommitedFile:
            with open(CommitedFilePath, 'w') as CommitedFile:
                if form.is_valid():
                    DjangFileObject = File(CommitedFile)
                    #Крепим файловый объект и данные из формы в модель
                    modelinstance.file = DjangFileObject
                    modelinstance.artist = form.cleaned_data['artist']
                    modelinstance.title = form.cleaned_data['title']
                    modelinstance.album = form.cleaned_data['album']
                    modelinstance.year = form.cleaned_data['year']
                    modelinstance.track = form.cleaned_data['track']
                    modelinstance.genre = form.cleaned_data['genre']
                    ### Обновление тэгов файла
#                   tags = id3.ID3(CommitedFile)
#                   tags.update_to_v23()
#                   tags.add(id3.TPE1(encoding=3 , text=SongCommit.cleaned_data.artist))
#                   tags.save()
                    ### Сохранение модели.
                    modelinstance.save()
                    return HttpResponse('<p>All Data Saved.</p>')
    return HttpResponse("<p>No actions found in views.upload for request's HTTP-method {}   OR FORM IS NOT VALID(NO FALURE PROCESSING CODE YET WRITTEN)</p>".format(request.method))
